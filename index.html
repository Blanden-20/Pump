<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Medidor dB + ThingSpeak (field6) + WhatsApp</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  /* ======== SPLASH ======== */
  #splash {
    position: fixed; inset: 0; z-index: 9999;
    display: grid; place-items: center;
    background: url('https://i.ibb.co/pvVGzw9b/Whats-App-Image-2025-08-16-at-4-02-43-PM.jpg') no-repeat center center fixed;
    background-size: cover;
    transition: opacity .5s ease;
  }
  #splash.hidden{ opacity:0; pointer-events:none; }
  .splash-screen {
    text-align: center; color: #fff;
    background-color: rgba(0,0,0,0.6);
    padding: 40px; border-radius: 15px;
    box-shadow: 0 4px 8px rgba(0,0,0,.3);
    animation: fadeIn 1s ease-in-out;
  }
  .splash-screen h1 { font-size: 3.2em; margin: 0 0 10px; text-shadow: 2px 2px 4px rgba(0,0,0,.5); }
  .splash-screen p { font-size: 1.4em; margin: 0 0 20px; }
  .splash-screen button {
    padding: 12px 30px; font-size: 1.2em; background-color: #28a745;
    color:#fff; border:0; border-radius:8px; cursor:pointer; transition: background-color .3s ease;
  }
  .splash-screen button:hover{ background-color:#218838; }
  @keyframes fadeIn { from{opacity:0; transform:scale(.98)} to{opacity:1; transform:scale(1)} }

  /* ======== APP ======== */
  :root{
    --bg:#121212; --card:#1e1e1e; --ink:#eaeaea; --muted:#b8b8b8;
    --cyan:#00e5ff; --good:#00e676; --bad:#ff1744; --accent:#77c589; --warn:#ffc107;
  }
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,Arial,sans-serif;margin:0}
  .page{max-width:1100px;margin:24px auto;padding:0 16px}
  .title{font-size:24px;font-weight:700;color:var(--cyan);text-align:center;margin:0 0 18px;text-shadow:0 0 6px #00e5ff44}
  .top-grid{display:grid;gap:20px;grid-template-columns: 1fr 1fr;align-items:start}
  @media (max-width: 900px){ .top-grid{grid-template-columns: 1fr} }
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card.pad{padding:18px 18px}
  .panel h3{margin:0 0 14px;font-size:18px;color:#8be9fd}
  .rows{display:flex;flex-direction:column;gap:12px}
  .row{display:grid;gap:12px;align-items:center;grid-template-columns: 1.3fr 1fr auto}
  .row.compact{grid-template-columns: 1.5fr auto 1fr}
  label{font-weight:700}
  .suffix{color:var(--muted)}
  .input{background:#0f0f0f;border:1px solid #2e2e2e;border-radius:12px;color:var(--ink);padding:12px 10px;font-size:16px;width:100%;text-align:center}
  .check{transform:scale(1.15)}
  .actions{display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .btn{background:var(--accent);border:none;color:#072a1f;font-weight:800;padding:10px 16px;border-radius:12px;cursor:pointer}
  .btn.test{background:#00e5ff;color:#00303a}
  .msg{font-size:12px}.ok{color:#69f0ae}.err{color:#ff5252}
  .info-block{margin-top:16px;padding:10px 12px;border-radius:12px;background:#151515;color:#cfd8dc;font-size:14px;display:grid;gap:4px}
  .info-block strong{color:#e5f5ff}
  .info-sub{font-size:13px;color:#9ee6ff;margin-left:18px}
  .gauge-card{padding:16px}
  #gaugeContainer{width:min(520px,100%);margin:6px auto 0;position:relative}
  #gaugeCanvas{width:100%;height:auto;display:block;aspect-ratio:1/1}
  .gauge-title{font-size:20px;font-weight:700;color:var(--cyan);text-align:center;margin:4px 0 8px}
  #centerValue{
    position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);
    font-size:36px;font-weight:900;color:#eaffff;text-shadow:0 0 10px #00e5ff77;padding:6px 12px;border-radius:12px
  }
  .chart-card{margin-top:20px;padding:18px}
  #chartContainer{width:100%;max-width:1000px;margin:0 auto}

  /* ===== Toasts flotantes ===== */
  .toast-container{
    position:fixed; right:16px; top:16px; z-index:99999;
    display:flex; flex-direction:column; gap:10px; pointer-events:none;
  }
  .toast{
    min-width:260px; max-width:360px; padding:12px 14px; border-radius:12px;
    background:#222; color:#fff; box-shadow:0 12px 28px rgba(0,0,0,.4);
    display:grid; grid-template-columns:auto 1fr auto; gap:10px; align-items:start;
    opacity:0; transform:translateY(-6px); animation:toast-in .2s ease forwards;
    pointer-events:auto;
  }
  .toast .t-title{font-weight:800; margin:0 0 4px; font-size:14px}
  .toast .t-msg{font-size:13px; color:#ddd}
  .toast button{ background:transparent; border:0; color:#fff; font-weight:900; cursor:pointer; opacity:.9; }
  .toast.info{border-left:4px solid var(--cyan)}
  .toast.ok{border-left:4px solid var(--good)}
  .toast.warn{border-left:4px solid var(--warn)}
  .toast.err{border-left:4px solid var(--bad)}
  @keyframes toast-in{to{opacity:1; transform:translateY(0)}}
  @keyframes toast-out{to{opacity:0; transform:translateY(-6px)}}

  /* Oculta scroll mientras splash est√° activo */
  body.lock-scroll{ overflow:hidden; }
</style>
</head>
<body class="lock-scroll">

  <!-- ======= SPLASH OVERLAY ======= -->
  <div id="splash" aria-label="Pantalla de bienvenida">
    <div class="splash-screen">
      <h1>BLADEN</h1>
      <p>20</p>
      <button id="enterBtn" type="button">Entrar</button>
    </div>
  </div>

  <!-- Contenedor de notificaciones flotantes -->
  <div class="toast-container" id="toasts"></div>

  <!-- ======= APP ======= -->
  <div id="app" style="visibility:hidden;">
    <div class="page">
      <h1 class="title">Medidor de Decibelios con Alertas y WhatsApp</h1>

      <div class="top-grid">
        <!-- Panel -->
        <div class="card pad panel">
          <h3>Alertas de nivel sonoro (dB) y WhatsApp</h3>
          <div class="rows">
            <div class="row">
              <label>üîâ Alerta BAJA &lt;</label>
              <input id="alertLow" class="input" type="number" min="0" step="1"/>
              <span class="suffix">dB</span>
            </div>
            <div class="row">
              <label>üîä Alerta ALTA &gt;</label>
              <input id="alertHigh" class="input" type="number" min="1" step="1"/>
              <span class="suffix">dB</span>
            </div>
            <div class="row">
              <label>üìà M√°x dB (escala gauge)</label>
              <input id="maxDb" class="input" type="number" min="40" step="5"/>
              <span class="suffix">dB</span>
            </div>
            <div class="row compact">
              <label>üìè Auto-escala gr√°fico</label>
              <input id="autoScale" class="check" type="checkbox"/>
              <span></span>
            </div>
            <div class="row compact">
              <label>‚úÖ Activar WhatsApp</label>
              <input id="waEnabled" class="check" type="checkbox"/>
              <span></span>
            </div>
            <div class="row">
              <label>‚è±Ô∏è Intervalo (min)</label>
              <input id="intervalMin" class="input" type="number" min="1" step="1"/>
              <span class="suffix">min</span>
            </div>
            <div class="row compact">
              <label>üåÄ Enviar cada lectura fuera de rango</label>
              <input id="everyOut" class="check" type="checkbox"/>
              <span></span>
            </div>

            <div class="actions">
              <button class="btn" id="btnSave">Guardar</button>
              <button class="btn test" id="btnTestWA">Probar WhatsApp</button>
              <span class="msg" id="saveMsg"></span>
            </div>
          </div>

          <!-- Estado -->
          <div class="info-block">
            <div>üìä <strong>√öltima lectura:</strong> <span id="lastReading">--</span></div>
            <div>
              üì® <strong>√öltimo WhatsApp:</strong> <span id="lastWhats">--</span>
              <div id="lastWhatsMsg" class="info-sub">--</div>
            </div>
          </div>
        </div>

        <!-- Gauge -->
        <div class="card gauge-card">
          <div class="gauge-title">Nivel Sonoro (dB)</div>
          <div id="gaugeContainer">
            <canvas id="gaugeCanvas"></canvas>
            <div id="centerValue">0</div>
          </div>
        </div>
      </div>

      <!-- Gr√°fica -->
      <div class="card chart-card">
        <div id="chartContainer">
          <canvas id="chart"></canvas>
        </div>
      </div>
    </div>
  </div>

<script>
/* ====== CONTROL SPLASH ====== */
(function(){
  const splash = document.getElementById('splash');
  const app = document.getElementById('app');
  const btn = document.getElementById('enterBtn');

  function showApp(){
    splash.classList.add('hidden');
    document.body.classList.remove('lock-scroll');
    setTimeout(()=>{ app.style.visibility='visible'; }, 400);
    requestNativeNotifPermission();
  }
  btn.addEventListener('click', showApp);
})();

/* ===== Util ===== */
function nowStr(){
  try { return new Date().toLocaleString('es-MX', { hour12:true }); }
  catch { return new Date().toLocaleString(); }
}
const clamp = (v,min,max)=>Math.min(Math.max(v,min),max);

/* ===== Toasts ===== */
const TOAST_TTL = 3800;
function toast(title, msg='', kind='info'){
  try{
    const cont = document.getElementById('toasts');
    const el = document.createElement('div');
    el.className = `toast ${kind}`;
    el.innerHTML = `
      <div style="font-size:18px;line-height:1">üîî</div>
      <div>
        <div class="t-title">${title}</div>
        <div class="t-msg">${msg}</div>
      </div>
      <button aria-label="cerrar">‚úï</button>
    `;
    const close = ()=>{ el.style.animation='toast-out .15s ease forwards'; setTimeout(()=>el.remove(), 150); };
    el.querySelector('button').onclick = close;
    cont.appendChild(el);
    setTimeout(close, TOAST_TTL);
  }catch(e){ console.warn('toast fail', e); }
}
// Para acciones manuales (con icono en el t√≠tulo)
const toastUser = (icon, title, msg='', kind='ok') => toast(`${icon} ${title}`, msg, kind);

/* ===== Notificaciones nativas ===== */
function requestNativeNotifPermission(){
  if(!('Notification' in window)) return;
  if(Notification.permission === 'default'){
    Notification.requestPermission().catch(()=>{});
  }
}
function notifyNative(title, body){
  try{
    if(document.visibilityState === 'hidden' && 'Notification' in window && Notification.permission === 'granted'){
      new Notification(title, { body });
    }
  }catch(e){}
}

/* ===== Config persistente ===== */
const LS_KEY = 'alertasWhats_dB_V1';
const defaults = { low:30, high:85, waEnabled:false, intervalMin:5, max:120, everyOut:false, autoScale:true };

const ui = {
  low: document.getElementById('alertLow'),
  high: document.getElementById('alertHigh'),
  maxDb: document.getElementById('maxDb'),
  autoScale: document.getElementById('autoScale'),
  waEnabled: document.getElementById('waEnabled'),
  intervalMin: document.getElementById('intervalMin'),
  everyOut: document.getElementById('everyOut'),
  btnSave: document.getElementById('btnSave'),
  btnTestWA: document.getElementById('btnTestWA'),
  saveMsg: document.getElementById('saveMsg'),
  lastReading: document.getElementById('lastReading'),
  lastWhats: document.getElementById('lastWhats'),
  lastWhatsMsg: document.getElementById('lastWhatsMsg')
};

function loadCfg(){ try{ return {...defaults, ...(JSON.parse(localStorage.getItem(LS_KEY))||{})}; }catch(e){ return {...defaults}; } }
function saveCfg(c){ localStorage.setItem(LS_KEY, JSON.stringify(c)); }

let cfg = loadCfg();
ui.low.value = cfg.low;
ui.high.value = cfg.high;
ui.maxDb.value = cfg.max;
ui.autoScale.checked = cfg.autoScale;
ui.waEnabled.checked = cfg.waEnabled;
ui.intervalMin.value = cfg.intervalMin;
ui.everyOut.checked = cfg.everyOut;

function setStatus(msg, ok=true){
  ui.saveMsg.textContent = msg;
  ui.saveMsg.className = 'msg ' + (ok ? 'ok' : 'err');
}

/* ======= TOASTS en los controles pedidos ======= */
ui.autoScale.addEventListener('change', ()=>{
  const on = ui.autoScale.checked;
  toastUser('üìè', 'Auto-escala gr√°fico', on ? 'Activada' : 'Desactivada', on ? 'ok' : 'warn');
});
ui.waEnabled.addEventListener('change', ()=>{
  const on = ui.waEnabled.checked;
  toastUser('‚úÖ', 'Activar WhatsApp', on ? 'Activado' : 'Desactivado', on ? 'ok' : 'warn');
});
ui.everyOut.addEventListener('change', ()=>{
  const on = ui.everyOut.checked;
  toastUser('üåÄ', 'Enviar cada lectura fuera de rango', on ? 'Activado' : 'Desactivado', on ? 'ok' : 'warn');
});

ui.btnSave.onclick = ()=>{
  const low = parseFloat(ui.low.value);
  const high = parseFloat(ui.high.value);
  const maxDb = Math.max(40, parseFloat(ui.maxDb.value || defaults.max));
  const intervalMin = Math.max(1, parseInt(ui.intervalMin.value||'1',10));
  const autoScale = ui.autoScale.checked;

  if(!(low>=0 && high>low)){ setStatus('Revisa umbrales: BAJA < ALTA', false); toastUser('üíæ','Guardar configuraci√≥n','Revisa umbrales: BAJA < ALTA','warn'); return; }
  if(high>maxDb){ setStatus('ALTA debe ser ‚â§ M√°x dB', false); toastUser('üíæ','Guardar configuraci√≥n','ALTA debe ser ‚â§ M√°x dB','warn'); return; }

  cfg = { low, high, waEnabled: ui.waEnabled.checked, intervalMin, max: maxDb, everyOut: ui.everyOut.checked, autoScale };
  saveCfg(cfg);

  if(!cfg.autoScale){
    chart.options.scales.y.min = 0;
    chart.options.scales.y.max = cfg.max;
  } else {
    applyYAxisAuto();
  }
  chart.update();
  drawGauge(displayedValue);

  setStatus('Guardado ‚úî', true);
  toastUser('üíæ', 'Guardar configuraci√≥n', `Low ${cfg.low} ‚Ä¢ High ${cfg.high} ‚Ä¢ Max ${cfg.max}`, 'ok');

  setWorkerInterval(15000); // fijo 15s (aj√∫stalo si quieres)
};

/* ===== Gauge ===== */
const canvas = document.getElementById('gaugeCanvas');
const ctx = canvas.getContext('2d');
const centerValueEl = document.getElementById('centerValue');

function fitCanvas(){
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio||1;
  canvas.width = r.width*dpr;
  canvas.height = r.height*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
const ro = new ResizeObserver(()=>{ fitCanvas(); drawGauge(displayedValue); });
ro.observe(canvas);

const startAngle=135, totalAngle=270;
let value=0, displayedValue=value;
const colorGreen='#00e676', colorRed='#ff1744';
function degToRad(d){ return (Math.PI/180)*d; }
function zoneColor(v){ if(v<cfg.low) return colorRed; if(v>cfg.high) return colorRed; return colorGreen; }

function niceStep(max){
  if(max<=60) return 5;
  if(max<=120) return 10;
  if(max<=200) return 20;
  const raw = Math.ceil(max/12);
  return Math.ceil(raw/5)*5;
}

function drawGauge(val){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 24, MAX = cfg.max;
  ctx.clearRect(0,0,w,h);

  const zones = [
    {s:0,        e:cfg.low,  c:colorRed},
    {s:cfg.low,  e:cfg.high, c:colorGreen},
    {s:cfg.high, e:MAX,      c:colorRed}
  ];
  zones.forEach(z=>{
    const s=degToRad(startAngle+(z.s/MAX)*totalAngle), e=degToRad(startAngle+(z.e/MAX)*totalAngle);
    ctx.beginPath(); ctx.lineWidth=Math.max(14, radius*0.13); ctx.strokeStyle=z.c;
    ctx.arc(cx,cy,radius,s,e); ctx.stroke();
  });

  ctx.lineWidth=2; ctx.font="12px Segoe UI"; ctx.fillStyle="#ccc";
  const step = niceStep(MAX);
  for(let i=0;i<=MAX;i+=step){
    const a=degToRad(startAngle+(i/MAX)*totalAngle);
    const x1=cx+Math.cos(a)*(radius-8), y1=cy+Math.sin(a)*(radius-8);
    const x2=cx+Math.cos(a)*(radius-24), y2=cy+Math.sin(a)*(radius-24);
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.strokeStyle="#fff"; ctx.stroke();
    const xt=cx+Math.cos(a)*(radius-40), yt=cy+Math.sin(a)*(radius-40);
    const wtxt=ctx.measureText(i.toString()).width; ctx.fillText(i.toString(), xt-wtxt/2, yt+4);
  }

  const clamped = clamp(val, 0, MAX);
  const needleAngle=degToRad(startAngle+(clamped/MAX)*totalAngle), needleLen=radius-40;
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(needleAngle)*needleLen, cy+Math.sin(needleAngle)*needleLen);
  ctx.strokeStyle="#ffbf00"; ctx.lineWidth=4; ctx.shadowColor="#ffbf00aa"; ctx.shadowBlur=8; ctx.stroke(); ctx.shadowBlur=0;

  ctx.beginPath(); ctx.arc(cx,cy,16,0,2*Math.PI); ctx.fillStyle="#ffd740"; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle="#555"; ctx.stroke();

  centerValueEl.textContent = clamp(displayedValue,0,MAX).toFixed(0);
  centerValueEl.style.textShadow = `0 0 10px ${zoneColor(displayedValue)}88`;
}

function animateNeedle(toVal,duration=350){
  toVal = clamp(toVal, 0, cfg.max);
  const from=displayedValue; const start=performance.now();
  function step(t){
    const p=Math.min(1,(t-start)/duration);
    const ease=p<0.5?2*p*p:-1+(4-2*p)*p;
    displayedValue=from+(toVal-from)*ease;
    drawGauge(displayedValue);
    if(p<1) requestAnimationFrame(step); else { displayedValue=toVal; drawGauge(displayedValue); }
  }
  requestAnimationFrame(step);
}
fitCanvas(); drawGauge(value);

/* ===== WhatsApp (CallMeBot) ===== */
const WA_PHONE = '+5212311560234';
const WA_APIKEY = '4036182';

async function sendWhatsApp(text){
  const url = "https://api.callmebot.com/whatsapp.php?phone="
            + encodeURIComponent(WA_PHONE)
            + "&text=" + encodeURIComponent(text)
            + "&apikey=" + encodeURIComponent(WA_APIKEY);

  try{
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), 8000);
    await fetch(url, {mode:'no-cors', signal: ac.signal});
    clearTimeout(t);
    setStatus('WhatsApp enviado (fetch).', true);
    return true;
  }catch(e){}

  try{
    await new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve();
      img.onerror = ()=>reject(new Error('img error'));
      img.src = url + '&cacheBust=' + Date.now();
    });
    setStatus('WhatsApp enviado (img).', true);
    return true;
  }catch(e){
    setStatus('No se pudo enviar WhatsApp.', false);
    return false;
  }
}

ui.btnTestWA.onclick = async ()=>{
  toastUser('üì≤', 'Probar WhatsApp', 'Enviando mensaje de prueba‚Ä¶', 'info');
  if(!ui.waEnabled.checked){ setStatus('Activa WhatsApp antes de probar.', false); toastUser('üì≤','Probar WhatsApp','Act√≠valo antes de probar.','warn'); return; }
  const msg = 'üîß Prueba de env√≠o desde el dashboard.';
  const ok = await sendWhatsApp(msg);
  if(ok){
    ui.lastWhats.textContent = nowStr();
    ui.lastWhatsMsg.textContent = msg;
    toastUser('üì≤','Probar WhatsApp','Mensaje enviado correctamente.','ok');
  }else{
    toastUser('üì≤','Probar WhatsApp','No se pudo enviar.','err');
  }
};

/* ===== Chart ===== */
const chartCtx = document.getElementById('chart').getContext('2d');
const chart = new Chart(chartCtx,{
  type:'line',
  data:{ labels:[], datasets:[{
    label:'dB', data:[],
    borderColor:'#00bcd4', backgroundColor:'rgba(0,188,212,.2)',
    tension:.3, fill:true, pointRadius:3.5, pointBackgroundColor:'#00e5ff', pointHoverRadius:6
  }]},
  options:{
    responsive:true, animation:false,
    interaction:{mode:'nearest',axis:'x',intersect:false},
    onClick:(e,els)=>{ if(els.length){ const i=els[0].index; value=chart.data.datasets[0].data[i]; animateNeedle(value); maybeAlert(value); } },
    layout:{padding:{left:4,right:10,top:8,bottom:6}},
    scales:{
      x:{ticks:{color:'#ccc'}},
      y:{min:0, max: defaults.max, ticks:{color:'#ccc'}}
    },
    plugins:{ legend:{labels:{color:'#ccc'}},
      tooltip:{ backgroundColor:'#222',titleColor:'#00e5ff',bodyColor:'#fff',titleFont:{weight:'bold'},
        callbacks:{ label:(c)=>`Valor: ${c.formattedValue} dB`, title:(c)=>`Hora: ${c[0].label}` } } }
  }
});

/* ---- Auto-escala del eje Y ---- */
function applyYAxisAuto(){
  const arr = chart.data.datasets[0].data;
  if(!cfg.autoScale || arr.length===0){
    chart.options.scales.y.min = 0;
    chart.options.scales.y.max = cfg.max;
    return;
  }
  let min = Math.min(...arr);
  let max = Math.max(...arr);
  if(min===max){ min -= 1; max += 1; }
  const pad = Math.max((max - min) * 0.1, 2);
  min = Math.floor(min - pad);
  max = Math.ceil(max + pad);
  min = Math.max(0, min);
  max = Math.min(cfg.max, max);
  if(max <= min){ max = min + 2; }
  chart.options.scales.y.min = min;
  chart.options.scales.y.max = max;
}

/* ===== Alertado ===== */
let lastSent = 0, lastState = 'normal';
function maybeAlert(v){
  const now = Date.now(), cooldown = (cfg.intervalMin||3) * 60 * 1000;
  let state = (v < cfg.low) ? 'low' : (v > cfg.high) ? 'high' : 'normal';
  const changed = (state !== lastState);
  const outOfRange = (state !== 'normal');

  const shouldSend = cfg.waEnabled && outOfRange &&
    ((cfg.everyOut && (now - lastSent) >= cooldown) || (!cfg.everyOut && changed && (now - lastSent) >= cooldown));

  if(shouldSend){
    let msg = (state==='low')
      ? `‚ö†Ô∏è Nivel SONORO BAJO: ${v} dB (umbral < ${cfg.low} dB)`
      : `‚ö†Ô∏è Nivel SONORO ALTO: ${v} dB (umbral > ${cfg.high} dB)`;
    sendWhatsApp(msg).then(ok=>{
      if(ok){
        lastSent = now;
        ui.lastWhats.textContent = nowStr();
        ui.lastWhatsMsg.textContent = msg;
        notifyNative('Alerta dB', msg);
      }
    });
  }
  lastState = state;
}

/* ===== ThingSpeak (field6) con Web Worker ===== */
const CHANNEL_ID  = 3036715;
const READ_APIKEY = "RT6C672EH8EJ9PEU";
const FIELD_NUM   = 1;

// Seguimiento para evitar repetir muestras
let lastSeenEntryId = null;
let lastSeenISO = null;

// Crear worker desde un blob
let pollIntervalMs = 15000; // default
let worker = null;

function startWorker(){
  try{
    const code = `
      let cfg = { channel: ${CHANNEL_ID}, key: ${JSON.stringify(READ_APIKEY)}, field: ${FIELD_NUM}, iv: ${pollIntervalMs} };
      let timer = null;
      async function tick(){
        try{
          const url = 'https://api.thingspeak.com/channels/'+cfg.channel+'/fields/'+cfg.field+'/last.json?api_key='+cfg.key+'&_='+(Date.now());
          const r = await fetch(url, { cache: 'no-store' });
          const j = await r.json();
          postMessage({ ok:true, data:j });
        }catch(e){
          postMessage({ ok:false, err: (e && e.message) ? e.message : 'error' });
        }
      }
      function loop(){ clearInterval(timer); timer = setInterval(tick, cfg.iv); tick(); }
      onmessage = (ev)=>{
        const m = ev.data||{};
        if(m.type==='config' && m.iv){
          cfg.iv = m.iv;
          loop();
        }else if(m.type==='kick'){
          tick();
        }
      };
      loop();
    `;
    const blob = new Blob([code], {type:'application/javascript'});
    const url = URL.createObjectURL(blob);
    worker = new Worker(url);
    worker.onmessage = onWorkerMsg;
  }catch(e){
    worker = null;
    setInterval(leerThingSpeakFallback, pollIntervalMs);
    leerThingSpeakFallback();
  }
}

function setWorkerInterval(ms){
  pollIntervalMs = Math.max(3000, Math.floor(ms));
  if(worker){ worker.postMessage({ type:'config', iv: pollIntervalMs }); }
}

function kickWorker(){
  if(worker){ worker.postMessage({ type:'kick' }); }
  else { leerThingSpeakFallback(); }
}

function onWorkerMsg(ev){
  const m = ev.data||{};
  if(!m.ok){
    setStatus('Error al leer ThingSpeak.', false);
    return;
  }
  handleThingSpeakData(m.data, /*fromWorker*/true);
}

// Fallback si no hay worker
async function leerThingSpeakFallback(){
  try{
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${FIELD_NUM}/last.json?api_key=${READ_APIKEY}&_=${Date.now()}`;
    const resp = await fetch(url, { cache: 'no-store' });
    const data = await resp.json();
    handleThingSpeakData(data, /*fromWorker*/false);
  }catch(err){
    setStatus('Error al leer ThingSpeak.', false);
  }
}

// Procesar dato (com√∫n para worker o fallback)
function handleThingSpeakData(data, fromWorker){
  if (!data){ setStatus('Sin datos de ThingSpeak.', false); return; }

  const entryId = data.entry_id ?? null;
  const createdAt = data.created_at ?? null;
  const raw = data[`field${FIELD_NUM}`];
  const valorBruto = parseFloat(raw);

  if (isNaN(valorBruto)) { 
    setStatus('Dato inv√°lido o ausente en ThingSpeak.', false);
    return; 
  }

  const sameEntry = (lastSeenEntryId !== null && entryId !== null && entryId === lastSeenEntryId);
  const sameTime  = (lastSeenISO !== null && createdAt !== null && createdAt === lastSeenISO);

  if (sameEntry || sameTime) {
    return; // sin actualizaci√≥n nueva -> no repetimos
  }

  // Nuevo dato
  if (entryId !== null) lastSeenEntryId = entryId;
  if (createdAt !== null) lastSeenISO = createdAt;

  const v = clamp(valorBruto, 0, cfg.max);
  value = v;
  animateNeedle(v);
  maybeAlert(v);

  const ts = createdAt ? new Date(createdAt).toLocaleTimeString('es-MX', { hour12:true }) 
                       : new Date().toLocaleTimeString('es-MX', { hour12:true });

  ui.lastReading.textContent = createdAt 
    ? new Date(createdAt).toLocaleString('es-MX', { hour12:true })
    : nowStr();

  chart.data.labels.push(ts);
  chart.data.datasets[0].data.push(v);
  if(chart.data.labels.length>120){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }

  if(cfg.autoScale) applyYAxisAuto();
  chart.update();
}

// iniciar worker
startWorker();

/* ===== Intervalo base y arranque ===== */
setWorkerInterval(15000); // 15s inicial
document.addEventListener('visibilitychange', ()=>{
  if(document.visibilityState === 'visible'){ kickWorker(); }
});
</script>
</body>
</html>
