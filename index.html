<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitor de Sonido</title>
  <style>
    :root {
      --bg: #f4f4f4; --fg: #333;
      --card-bg: #fff; --card-shadow: rgba(0,0,0,0.1);
      --accent: #4caf50; --danger: #f44336; --warn: #ffeb3b;
      --toast-bg: #4caf50;
    }
    .dark-mode {
      --bg: #121212; --fg: #eee;
      --card-bg: #1e1e1e; --card-shadow: rgba(0,0,0,0.7);
      --accent: #81C784; --danger: #E57373; --warn: #FFF176;
      --toast-bg: #333;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      background: var(--bg); color: var(--fg);
      font-family: Arial, sans-serif;
      display: flex; flex-direction: column; align-items: center;
      padding: 1rem; transition: background .3s, color .3s;
    }
    h1 {
      display: flex; align-items: center; gap: .5rem;
      width: 100%; max-width: 800px;
      font-size: 1.8rem; margin-bottom: 1rem;
    }
    #themeToggle {
      margin-left: auto; padding: .25rem .5rem;
      background: var(--card-bg); color: var(--fg);
      border: none; border-radius: 4px; cursor: pointer;
      box-shadow: 0 1px 3px var(--card-shadow);
      transition: background .3s, color .3s;
    }
    .main-content {
      display: flex; gap: 2rem;
      width: 100%; max-width: 800px;
      flex-wrap: wrap; justify-content: center;
    }
    .card {
      background: var(--card-bg);
      box-shadow: 0 2px 6px var(--card-shadow);
      border-radius: 8px; padding: 1rem;
      width: 360px; margin-bottom: 1.5rem;
    }
    .controls form {
      display: grid;
      grid-template-columns: 1fr auto 4rem auto;
      row-gap: .75rem; column-gap: .5rem;
      align-items: center;
    }
    .controls label {
      display: flex; align-items: center; gap: .5rem;
      font-weight: bold;
    }
    .controls input[type="number"] {
      width: 100%; padding: .25rem .5rem;
      background: var(--bg); color: var(--fg);
      border: 1px solid var(--card-shadow);
      border-radius: 4px; text-align: center;
      transition: background .3s, color .3s, border-color .3s;
    }
    .controls input[type="checkbox"] { transform: scale(1.2); }
    .controls button {
      grid-column: 2 / span 3; padding: .5rem;
      background: var(--accent); color: #fff;
      border: none; border-radius: 4px;
      cursor: pointer; font-weight: bold;
      transition: background .3s;
    }
    .controls button:hover { background: var(--danger); }

    .visual-container {
      display: flex; flex-direction: column;
      align-items: center;
    }
    #gaugeContainer {
      width: 300px; height: 300px; margin-bottom: 1rem;
    }
    #gauge {
      width: 100%; height: 100%;
    }
    .status {
      text-align: center; font-size: .9rem;
      line-height: 1.4;
    }
    .notification {
      position: fixed; top: 1rem; right: 1rem;
      background: var(--toast-bg); color: #fff;
      padding: .75rem 1.25rem; border-radius: 4px;
      box-shadow: 0 2px 6px var(--card-shadow);
      display: flex; align-items: center; gap: .5rem;
      opacity: 0; transform: translateY(-20px);
      transition: opacity .3s, transform .3s;
      z-index: 1000;
    }
    .notification.show {
      opacity: 1; transform: translateY(0);
    }
    .notification .icon { font-size: 1.2rem; }

    @keyframes pulse-red {
      0% { box-shadow: 0 0 0px var(--danger); }
      50% { box-shadow: 0 0 20px 10px var(--danger); }
      100% { box-shadow: 0 0 0px var(--danger); }
    }
    @keyframes pulse-green {
      0% { box-shadow: 0 0 0px var(--accent); }
      50% { box-shadow: 0 0 20px 10px var(--accent); }
      100% { box-shadow: 0 0 0px var(--accent); }
    }
    #gaugeContainer.alert-red   { animation: pulse-red .8s ease-out; }
    #gaugeContainer.alert-green { animation: pulse-green .8s ease-out; }

    @media (max-width: 768px) {
      .main-content { flex-direction: column; align-items: center; }
    }
  </style>
</head>
<body>
  <h1>
    Monitor de Sonido
    <button id="themeToggle">üåó Tema</button>
  </h1>

  <div class="main-content">
    <div class="card controls">
      <form id="thresholdForm">
        <label for="lowThresholdInput">üîà Alerta BAJA &lt;</label>
        <input type="number" id="lowThresholdInput" min="0" max="150"/>
        <span>dB</span><span></span>

        <label for="highThresholdInput">üîä Alerta ALTA &gt;</label>
        <input type="number" id="highThresholdInput" min="0" max="150"/>
        <span>dB</span><span></span>

        <label for="whatsappCheckbox">Activar WhatsApp</label>
        <input type="checkbox" id="whatsappCheckbox"/>
        <span></span><span></span>

        <label for="alertIntervalInput">‚è±Ô∏è Intervalo (min)</label>
        <input type="number" id="alertIntervalInput" min="1" value="5"/>
        <span></span>
        <button type="submit">Guardar</button>
      </form>
    </div>

    <div class="visual-container">
      <div id="gaugeContainer">
        <canvas id="gauge" width="300" height="300"></canvas>
      </div>
      <div class="status">
        <div id="lastUpdate">√öltima lectura: --</div>
        <div id="lastWhatsApp">√öltimo WhatsApp: --</div>
      </div>
    </div>
  </div>

  <audio id="alertSound" src="alert.mp3" preload="auto"></audio>
  <div id="notification" class="notification">
    <span class="icon">üíæ</span>
    <span id="notificationText">Umbrales guardados</span>
  </div>

  <script>
    const UPDATE_MS   = 5000,
          CHANNEL_ID  = 3002997,
          READ_APIKEY = '4YNKSM88V7TMKB68';

    // tema sin recarga
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    if (localStorage.theme === 'dark') body.classList.add('dark-mode');
    themeToggle.onclick = () => {
      const dark = body.classList.toggle('dark-mode');
      localStorage.theme = dark ? 'dark' : 'light';
    };

    // colores
    const warnColor   = getComputedStyle(body).getPropertyValue('--warn').trim(),
          accentColor = getComputedStyle(body).getPropertyValue('--accent').trim(),
          dangerColor = getComputedStyle(body).getPropertyValue('--danger').trim();

    // canvas setup
    const canvas = document.getElementById('gauge'),
          ctx    = canvas.getContext('2d'),
          size   = 300,
          cx     = size / 2,
          cy     = size / 2,
          r      = size * 0.4;

    let lowTh, highTh;
    function initThresholds() {
      lowTh  = +(localStorage.lowThreshold  || 20);
      highTh = +(localStorage.highThreshold || 80);
      lowInput.value  = lowTh;
      highInput.value = highTh;
    }

    function drawGauge(val) {
      // relee fg en cada llamada para modo oscuro
      const labelColor = getComputedStyle(body).getPropertyValue('--fg').trim();

      ctx.clearRect(0, 0, size, size);
      ctx.lineWidth = size * 0.08;
      const start = Math.PI, end = 2 * Math.PI,
            aLow  = start + (lowTh / 150) * Math.PI,
            aHigh = start + (highTh / 150) * Math.PI;

      // sectores
      ctx.beginPath(); ctx.strokeStyle = warnColor;
      ctx.arc(cx, cy, r, start, aLow, false); ctx.stroke();
      ctx.beginPath(); ctx.strokeStyle = accentColor;
      ctx.arc(cx, cy, r, aLow, aHigh, false); ctx.stroke();
      ctx.beginPath(); ctx.strokeStyle = dangerColor;
      ctx.arc(cx, cy, r, aHigh, end, false); ctx.stroke();

      // indicadores 0 y 150
      ctx.font = '14px Arial';
      ctx.fillStyle = labelColor;
      ctx.textAlign = 'center';
      ctx.fillText('0', cx - r, cy + r * 0.2);
      ctx.fillText('150', cx + r, cy + r * 0.2);

      // aguja
      const angle = start + (val / 150) * Math.PI;
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(angle);
      ctx.beginPath();
      ctx.moveTo(-size * 0.02, 0);
      ctx.lineTo(r * 0.9, 0);
      ctx.lineWidth   = size * 0.01;
      ctx.strokeStyle = labelColor;
      ctx.stroke();
      ctx.restore();

      // c√≠rculo central
      ctx.beginPath();
      ctx.arc(cx, cy, size * 0.03, 0, 2 * Math.PI);
      ctx.fillStyle = labelColor;
      ctx.fill();

      // valor + unidad
      ctx.font = 'bold 24px Arial';
      ctx.fillStyle = labelColor;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(val.toFixed(0) + ' dB', cx, cy + size * 0.15);
    }

    // refs
    const form             = document.getElementById('thresholdForm'),
          lowInput         = document.getElementById('lowThresholdInput'),
          highInput        = document.getElementById('highThresholdInput'),
          whatsappCheckbox = document.getElementById('whatsappCheckbox'),
          intervalInput    = document.getElementById('alertIntervalInput'),
          notification     = document.getElementById('notification'),
          notifIcon        = notification.querySelector('.icon'),
          notifText        = document.getElementById('notificationText'),
          lastUpdateEl     = document.getElementById('lastUpdate'),
          lastWAEl         = document.getElementById('lastWhatsApp');

    function showNotification(text, icon='üíæ') {
      notifIcon.textContent = icon;
      notifText.textContent = text;
      notification.classList.add('show');
      setTimeout(()=>notification.classList.remove('show'),2000);
    }

    form.onsubmit = e => {
      e.preventDefault();
      localStorage.lowThreshold    = lowInput.value;
      localStorage.highThreshold   = highInput.value;
      localStorage.whatsappEnabled = whatsappCheckbox.checked;
      localStorage.alertInterval   = intervalInput.value;
      lowAlerted = highAlerted = false;
      showNotification('Umbrales guardados','üíæ');
      initThresholds();
    };

    whatsappCheckbox.onchange = () => {
      showNotification(
        whatsappCheckbox.checked?'WhatsApp activado':'WhatsApp desactivado',
        'üì≤'
      );
    };

    function formatTimestamp(d){
      return d.toLocaleDateString('es-ES')+', '+d.toLocaleTimeString('es-ES',{
        hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:true
      });
    }

    function sendWhatsApp(msg){
      new Image().src =
        `https://api.callmebot.com/whatsapp.php?phone=+5212311560234`+
        `&text=${encodeURIComponent(msg)}&apikey=4036182`;
      showNotification('WhatsApp enviado','üîä');
    }

    let lowAlerted=false, highAlerted=false, lastAlertTime=0;
    function triggerAlert(type,val){
      const now=(new Date()).getTime(),
            interval=(parseInt(localStorage.alertInterval)||5)*60000;
      if(now - lastAlertTime < interval) return;
      lastAlertTime = now;
      const gc = document.getElementById('gaugeContainer');
      gc.classList.add(type==='high'?'alert-red':'alert-green');
      setTimeout(()=>gc.classList.remove('alert-red','alert-green'),800);
      document.getElementById('alertSound').play();
      const txt=`‚ö†Ô∏è Alerta üîä ${type==='high'?'ALTA':'BAJA'}: ${val.toFixed(0)} dB a las ${formatTimestamp(new Date())}`;
      if(localStorage.whatsappEnabled==='true'){
        sendWhatsApp(txt);
        const wa = formatTimestamp(new Date());
        localStorage.lastWhatsApp = wa;
        lastWAEl.textContent = '√öltimo WhatsApp: '+wa;
      }
    }

    async function updateAll(){
      try {
        const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/6.json?api_key=${READ_APIKEY}&results=1`;
        const { feeds } = await fetch(url).then(r=>r.json());
        if(!feeds?.length) return;
        const feed = feeds[0],
              ts   = new Date(feed.created_at),
              val  = Math.min(Math.max(parseFloat(feed.field6)||0,0),150);

        drawGauge(val);
        lastUpdateEl.textContent = '√öltima lectura: '+formatTimestamp(ts);

        if(val < lowTh && !lowAlerted) {
          lowAlerted = true;  triggerAlert('low', val);
        } else if(val > highTh && !highAlerted) {
          highAlerted = true; triggerAlert('high', val);
        } else if(val >= lowTh && val <= highTh) {
          lowAlerted = highAlerted = false;
        }
      } catch(e) {
        console.error(e);
      }
    }

    // arranque
    initThresholds();
    drawGauge(0);
    updateAll();
    setInterval(updateAll, UPDATE_MS);
  </script>
</body>
</html>

