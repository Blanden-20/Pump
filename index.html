<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Medidor dB + ThingSpeak (field6) + WhatsApp</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
  :root{
    --bg:#121212; --card:#1e1e1e; --ink:#eaeaea; --muted:#b8b8b8;
    --cyan:#00e5ff; --good:#00e676; --bad:#ff1744; --accent:#77c589;
  }
  body{background:var(--bg);color:var(--ink);font-family:'Segoe UI',system-ui,Arial,sans-serif;margin:0}
  .page{max-width:1100px;margin:24px auto;padding:0 16px}

  .title{font-size:24px;font-weight:700;color:var(--cyan);text-align:center;margin:0 0 18px;text-shadow:0 0 6px #00e5ff44}

  .top-grid{display:grid;gap:20px;grid-template-columns: 1fr 1fr;align-items:start}
  @media (max-width: 900px){ .top-grid{grid-template-columns: 1fr} }

  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
  .card.pad{padding:18px 18px}

  .panel h3{margin:0 0 14px;font-size:18px;color:#8be9fd}
  .rows{display:flex;flex-direction:column;gap:12px}
  .row{display:grid;gap:12px;align-items:center;grid-template-columns: 1.3fr 1fr auto}
  .row.compact{grid-template-columns: 1.5fr auto 1fr}
  label{font-weight:700}
  .suffix{color:var(--muted)}
  .input{background:#0f0f0f;border:1px solid #2e2e2e;border-radius:12px;color:var(--ink);padding:12px 10px;font-size:16px;width:100%;text-align:center}
  .check{transform:scale(1.15)}
  .actions{display:flex;gap:12px;align-items:center;margin-top:6px;flex-wrap:wrap}
  .btn{background:var(--accent);border:none;color:#072a1f;font-weight:800;padding:10px 16px;border-radius:12px;cursor:pointer}
  .btn.test{background:#00e5ff;color:#00303a}
  .msg{font-size:12px}.ok{color:#69f0ae}.err{color:#ff5252}

  /* Info block */
  .info-block{margin-top:16px;padding:10px 12px;border-radius:12px;background:#151515;color:#cfd8dc;font-size:14px;display:grid;gap:4px}
  .info-block strong{color:#e5f5ff}
  .info-sub{font-size:13px;color:#9ee6ff;margin-left:18px}

  /* Gauge */
  .gauge-card{padding:16px}
  #gaugeContainer{width:min(520px,100%);margin:6px auto 0;position:relative}
  #gaugeCanvas{width:100%;height:auto;display:block;aspect-ratio:1/1}
  .gauge-title{font-size:20px;font-weight:700;color:var(--cyan);text-align:center;margin:4px 0 8px}
  #centerValue{
    position:absolute;left:50%;top:62%;transform:translate(-50%,-50%);
    font-size:36px;font-weight:900;color:#eaffff;text-shadow:0 0 10px #00e5ff77;padding:6px 12px;border-radius:12px
  }

  /* Gr√°fica */
  .chart-card{margin-top:20px;padding:18px}
  #chartContainer{width:100%;max-width:1000px;margin:0 auto}
</style>
</head>
<body>
  <div class="page">
    <h1 class="title">Medidor de Decibelios con Alertas y WhatsApp</h1>

    <div class="top-grid">
      <!-- Panel -->
      <div class="card pad panel">
        <h3>Alertas de nivel sonoro (dB) y WhatsApp</h3>
        <div class="rows">
          <div class="row">
            <label>üîâ Alerta BAJA &lt;</label>
            <input id="alertLow" class="input" type="number" min="0" step="1"/>
            <span class="suffix">dB</span>
          </div>
          <div class="row">
            <label>üîä Alerta ALTA &gt;</label>
            <input id="alertHigh" class="input" type="number" min="1" step="1"/>
            <span class="suffix">dB</span>
          </div>
          <div class="row compact">
            <label>‚úÖ Activar WhatsApp</label>
            <input id="waEnabled" class="check" type="checkbox"/>
            <span></span>
          </div>
          <div class="row">
            <label>‚è±Ô∏è Intervalo (min)</label>
            <input id="intervalMin" class="input" type="number" min="1" step="1"/>
            <span class="suffix">min</span>
          </div>
          <!-- NUEVO: enviar cada lectura fuera de rango -->
          <div class="row compact">
            <label>üåÄ Enviar cada lectura fuera de rango</label>
            <input id="everyOut" class="check" type="checkbox"/>
            <span></span>
          </div>

          <div class="actions">
            <button class="btn" id="btnSave">Guardar</button>
            <button class="btn test" id="btnTestWA">Probar WhatsApp</button>
            <span class="msg" id="saveMsg"></span>
          </div>
        </div>

        <!-- Estado -->
        <div class="info-block">
          <div>üìä <strong>√öltima lectura:</strong> <span id="lastReading">--</span></div>
          <div>
            üì® <strong>√öltimo WhatsApp:</strong> <span id="lastWhats">--</span>
            <div id="lastWhatsMsg" class="info-sub">--</div>
          </div>
        </div>
      </div>

      <!-- Gauge -->
      <div class="card gauge-card">
        <div class="gauge-title">Nivel Sonoro (dB)</div>
        <div id="gaugeContainer">
          <canvas id="gaugeCanvas"></canvas>
          <div id="centerValue">0</div>
        </div>
      </div>
    </div>

    <!-- Gr√°fica -->
    <div class="card chart-card">
      <div id="chartContainer">
        <canvas id="chart"></canvas>
      </div>
    </div>
  </div>

<script>
/* ===== Util ===== */
function nowStr(){
  try { return new Date().toLocaleString('es-MX', { hour12:true }); }
  catch { return new Date().toLocaleString(); }
}

/* ===== Config persistente ===== */
const LS_KEY = 'alertasWhats_dB_V1';
const defaults = { low:30, high:85, waEnabled:false, intervalMin:5, max:120, everyOut:false };
const ui = {
  low: alertLow, high: alertHigh, waEnabled, intervalMin, everyOut,
  btnSave: btnSave, btnTestWA: btnTestWA, saveMsg: saveMsg,
  lastReading: document.getElementById('lastReading'),
  lastWhats: document.getElementById('lastWhats'),
  lastWhatsMsg: document.getElementById('lastWhatsMsg')
};
function loadCfg(){ try{ return {...defaults, ...(JSON.parse(localStorage.getItem(LS_KEY))||{})}; }catch(e){ return {...defaults}; } }
function saveCfg(c){ localStorage.setItem(LS_KEY, JSON.stringify(c)); }
let cfg = loadCfg();
ui.low.value = cfg.low; ui.high.value = cfg.high; ui.waEnabled.checked = cfg.waEnabled; ui.intervalMin.value = cfg.intervalMin; ui.everyOut.checked = cfg.everyOut;

ui.btnSave.onclick = ()=>{
  const low = parseFloat(ui.low.value);
  const high = parseFloat(ui.high.value);
  const intervalMin = Math.max(1, parseInt(ui.intervalMin.value||'1',10));
  cfg = { low, high, waEnabled: ui.waEnabled.checked, intervalMin, max: defaults.max, everyOut: ui.everyOut.checked };
  if(!(low>=0 && high>low)){ setStatus('Revisa umbrales: BAJA < ALTA', false); return; }
  saveCfg(cfg);
  setStatus('Guardado ‚úî', true);
  drawGauge(displayedValue);
};

/* ===== Gauge ===== */
const canvas = document.getElementById('gaugeCanvas');
const ctx = canvas.getContext('2d');
const centerValueEl = document.getElementById('centerValue');

function fitCanvas(){
  const r = canvas.getBoundingClientRect();
  const dpr = window.devicePixelRatio||1;
  canvas.width = r.width*dpr;
  canvas.height = r.height*dpr;
  ctx.setTransform(dpr,0,0,dpr,0,0);
}
const ro = new ResizeObserver(()=>{ fitCanvas(); drawGauge(displayedValue); });
ro.observe(canvas);

const startAngle=135, totalAngle=270;
let value=0, displayedValue=value;
const colorGreen='#00e676', colorRed='#ff1744';
function degToRad(d){ return (Math.PI/180)*d; }
function zoneColor(v){ if(v<cfg.low) return colorRed; if(v>cfg.high) return colorRed; return colorGreen; }

function drawGauge(val){
  const w = canvas.clientWidth, h = canvas.clientHeight;
  const cx = w/2, cy = h/2, radius = Math.min(w,h)/2 - 24, MAX = cfg.max;
  ctx.clearRect(0,0,w,h);

  const zones = [
    {s:0,        e:cfg.low,  c:colorRed},
    {s:cfg.low,  e:cfg.high, c:colorGreen},
    {s:cfg.high, e:MAX,      c:colorRed}
  ];
  zones.forEach(z=>{
    const s=degToRad(startAngle+(z.s/MAX)*totalAngle), e=degToRad(startAngle+(z.e/MAX)*totalAngle);
    ctx.beginPath(); ctx.lineWidth=Math.max(14, radius*0.13); ctx.strokeStyle=z.c;
    ctx.arc(cx,cy,radius,s,e); ctx.stroke();
  });

  ctx.lineWidth=2; ctx.font="12px Segoe UI"; ctx.fillStyle="#ccc";
  for(let i=0;i<=MAX;i+=10){
    const a=degToRad(startAngle+(i/MAX)*totalAngle);
    const x1=cx+Math.cos(a)*(radius-8), y1=cy+Math.sin(a)*(radius-8);
    const x2=cx+Math.cos(a)*(radius-24), y2=cy+Math.sin(a)*(radius-24);
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.strokeStyle="#fff"; ctx.stroke();
    const xt=cx+Math.cos(a)*(radius-40), yt=cy+Math.sin(a)*(radius-40);
    const wtxt=ctx.measureText(i.toString()).width; ctx.fillText(i.toString(), xt-wtxt/2, yt+4);
  }

  const needleAngle=degToRad(startAngle+(val/MAX)*totalAngle), needleLen=radius-40;
  ctx.beginPath(); ctx.moveTo(cx,cy); ctx.lineTo(cx+Math.cos(needleAngle)*needleLen, cy+Math.sin(needleAngle)*needleLen);
  ctx.strokeStyle="#ffbf00"; ctx.lineWidth=4; ctx.shadowColor="#ffbf00aa"; ctx.shadowBlur=8; ctx.stroke(); ctx.shadowBlur=0;

  ctx.beginPath(); ctx.arc(cx,cy,16,0,2*Math.PI); ctx.fillStyle="#ffd740"; ctx.fill(); ctx.lineWidth=3; ctx.strokeStyle="#555"; ctx.stroke();

  centerValueEl.textContent = Math.round(value);
  centerValueEl.style.textShadow = `0 0 10px ${zoneColor(value)}88`;
}
function animateNeedle(toVal,duration=350){
  const from=displayedValue; const start=performance.now();
  function step(t){ const p=Math.min(1,(t-start)/duration); const ease=p<0.5?2*p*p:-1+(4-2*p)*p;
    displayedValue=from+(toVal-from)*ease; drawGauge(displayedValue);
    if(p<1) requestAnimationFrame(step); else displayedValue=toVal;
  } requestAnimationFrame(step);
}
fitCanvas(); drawGauge(value);

/* ===== WhatsApp (CallMeBot) ===== */
const WA_PHONE = '+5212311560234';
const WA_APIKEY = '4036182';

// Estado visual en el panel
function setStatus(msg, ok=true){
  ui.saveMsg.textContent = msg;
  ui.saveMsg.className = 'msg ' + (ok ? 'ok' : 'err');
}

// Env√≠o con fetch + timeout y fallback a <img>
async function sendWhatsApp(text){
  const url = "https://api.callmebot.com/whatsapp.php?phone="
            + encodeURIComponent(WA_PHONE)
            + "&text=" + encodeURIComponent(text)
            + "&apikey=" + encodeURIComponent(WA_APIKEY);

  // 1) fetch con timeout
  try{
    const ac = new AbortController();
    const t = setTimeout(()=>ac.abort(), 8000);
    await fetch(url, {mode:'no-cors', signal: ac.signal});
    clearTimeout(t);
    setStatus('WhatsApp enviado (fetch).', true);
    return true;
  }catch(e){
    console.warn('fetch WA fall√≥, probando fallback IMG:', e);
  }

  // 2) Fallback <img>
  try{
    await new Promise((resolve,reject)=>{
      const img = new Image();
      img.onload = ()=>resolve();
      img.onerror = ()=>reject(new Error('img error'));
      img.src = url + '&cacheBust=' + Date.now(); // evita cach√©
    });
    setStatus('WhatsApp enviado (img).', true);
    return true;
  }catch(e){
    console.error('fallback IMG tambi√©n fall√≥:', e);
    setStatus('No se pudo enviar WhatsApp.', false);
    return false;
  }
}

// Bot√≥n de prueba
ui.btnTestWA.onclick = async ()=>{
  if(!ui.waEnabled.checked){ setStatus('Activa WhatsApp antes de probar.', false); return; }
  const msg = 'üîß Prueba de env√≠o desde el dashboard.';
  const ok = await sendWhatsApp(msg);
  if(ok){
    ui.lastWhats.textContent = nowStr();
    ui.lastWhatsMsg.textContent = msg;
  }
};

/* ===== Chart ===== */
const chartCtx = document.getElementById('chart').getContext('2d');
const chart = new Chart(chartCtx,{
  type:'line',
  data:{ labels:[], datasets:[{ label:'dB', data:[], borderColor:'#00bcd4', backgroundColor:'rgba(0,188,212,.2)', tension:.3, fill:true, pointRadius:3.5, pointBackgroundColor:'#00e5ff', pointHoverRadius:6 }] },
  options:{
    responsive:true, animation:false,
    interaction:{mode:'nearest',axis:'x',intersect:false},
    onClick:(e,els)=>{ if(els.length){ const i=els[0].index; value=chart.data.datasets[0].data[i]; animateNeedle(value); maybeAlert(value); } },
    layout:{padding:{left:4,right:10,top:8,bottom:6}},
    scales:{ x:{ticks:{color:'#ccc'}}, y:{min:0,max:()=>cfg.max,ticks:{color:'#ccc'}} },
    plugins:{ legend:{labels:{color:'#ccc'}},
      tooltip:{ backgroundColor:'#222',titleColor:'#00e5ff',bodyColor:'#fff',titleFont:{weight:'bold'},
        callbacks:{ label:(c)=>`Valor: ${c.formattedValue} dB`, title:(c)=>`Hora: ${c[0].label}` } } }
  }
});

/* ===== Alertado ===== */
let lastSent = 0, lastState = 'normal';

function maybeAlert(v){
  const now = Date.now(), cooldown = (cfg.intervalMin||3) * 60 * 1000;
  let state = (v < cfg.low) ? 'low' : (v > cfg.high) ? 'high' : 'normal';

  const changed = (state !== lastState);
  const outOfRange = (state !== 'normal');

  // Si everyOut est√° activo, enviamos cada lectura fuera de rango respetando cooldown
  const shouldSend = cfg.waEnabled && outOfRange &&
                     ((cfg.everyOut && (now - lastSent) >= cooldown) || (!cfg.everyOut && changed && (now - lastSent) >= cooldown));

  if(shouldSend){
    let msg = (state==='low')
      ? `‚ö†Ô∏è Nivel SONORO BAJO: ${v} dB (umbral < ${cfg.low} dB)`
      : `‚ö†Ô∏è Nivel SONORO ALTO: ${v} dB (umbral > ${cfg.high} dB)`;
    sendWhatsApp(msg).then(ok=>{
      if(ok){
        lastSent = now;
        ui.lastWhats.textContent = nowStr();
        ui.lastWhatsMsg.textContent = msg;
      }
    });
  }
  lastState = state;
}

/* ===== ThingSpeak (field6) ===== */
const CHANNEL_ID  = 3002997;
const READ_APIKEY = "4YNKSM88V7TMKB68";
const FIELD_NUM   = 6;

async function leerThingSpeak(){
  try {
    const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/fields/${FIELD_NUM}/last.json?api_key=${READ_APIKEY}`;
    const resp = await fetch(url);
    const data = await resp.json();
    const valor = parseFloat(data[`field${FIELD_NUM}`]);
    if (!isNaN(valor)) {
      value = valor;
      animateNeedle(value);
      maybeAlert(value);

      ui.lastReading.textContent = nowStr();

      const ts = new Date().toLocaleTimeString('es-MX', { hour12:true });
      chart.data.labels.push(ts);
      chart.data.datasets[0].data.push(value);
      if(chart.data.labels.length>60){ chart.data.labels.shift(); chart.data.datasets[0].data.shift(); }
      chart.update();
    }
  } catch (err) {
    console.error("Error al leer ThingSpeak:", err);
    setStatus('Error al leer ThingSpeak.', false);
  }
}
setInterval(leerThingSpeak, 15000);
leerThingSpeak();
</script>
</body>
</html>
